<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <h1>Cool Midi Stuff</h1>
    <h3>All notes being held down</h3>
    <div id="dispDiv"></div>
    <h3>Current four notes</h3>
    <div id="disp2Div"></div>
    <h3>Current four notes as Names</h3>
    <div id="disp3Div"></div>
  </body>
<script>
  var context = new AudioContext();

  var curNoteArray = [];
  var curFourNotes = [];

  if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess()
          .then(success, failure);
  }

  function onMIDIMessage (message) {
      console.log(message.data);//[0] = on/off (144=on, 128=off), [1] = note number(c3=60), [2] = velocity(0-127)
      //note: for now, it only works when "Bank A/B" is red and the rest of the buttons are off

      if (message.data[0] === 144 && message.data[2] > 0) {
          curNoteArray.push(message.data[1])
          console.log(curNoteArray)
          curNoteArray.sort()
          curNoteArray = removeDups(curNoteArray);
          //TODO: Add functionality to take the bottom 2 and top 2 and form them into the array
          document.querySelector('#dispDiv').innerHTML = ''+curNoteArray;
          curFourNotes = getFourNotes(curNoteArray);
      }

      if (message.data[0] === 128 || message.data[2] === 0) {
          console.log("removing element at index: "+curNoteArray.indexOf(message.data[1]));
          curNoteArray.splice(curNoteArray.indexOf(message.data[1]), 1)
          document.querySelector('#dispDiv').innerHTML = ''+curNoteArray;
          curFourNotes = getFourNotes(curNoteArray);
      }
      noteNameArray = getNoteNameArray(curFourNotes);

      document.querySelector('#disp2Div').innerHTML = ''+curFourNotes;
      document.querySelector('#disp3Div').innerHTML = ''+noteNameArray;


      // console.log("HHHHHHH")
  }

  function success (midi) {
      var inputs = midi.inputs.values();
      // inputs is an Iterator

      for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
          // each time there is a midi message call the onMIDIMessage function
          input.value.onmidimessage = onMIDIMessage;
      }
  }

  function failure () {
      console.error('No access to your midi devices.')
  }
  function removeDups(arrIn) {
    let unique = [];
    for(i = 0; i < arrIn.length; i++){
      if(!unique.includes(arrIn[i])){
        unique.push(arrIn[i]);
      }
    }
    return unique;
  }

  function getFourNotes(arrIn){
    var retVal = [];
    if(arrIn.length <= 4){
      return arrIn;
    }
    retVal.push(arrIn[0]);
    retVal.push(arrIn[1]);
    retVal.push(arrIn[arrIn.length-2]);
    retVal.push(arrIn[arrIn.length-1]);
    return retVal;
  }

  function getNoteName(initialNote){
    var noteString = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    var octave = parseInt(initialNote / 12) - 1;
    var noteIndex = (initialNote % 12);
    var note = noteString[noteIndex];

    return note + octave;
  }

  function getNoteNameArray(fourArrayIn){
    retVal = [];
    for(i = 0; i < fourArrayIn.length; i++){
      retVal.push(getNoteName(fourArrayIn[i]));
    }
    return retVal;
  }




</script>
</html>
