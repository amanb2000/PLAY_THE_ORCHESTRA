<html>
<title>Slave</title>
<script src="/socket.io/socket.io.js"></script>
<html>
<style>
.hideimg {
  display: none;
}

</style>
<body>
<h1 id="section-name">Section</h1>
<h1>Key: </h1>
<p id="key-name">C</p>
<canvas id="main" width=800 height=260></canvas>
<img class="hideimg" id="staff" onload="drawStaff()" src="">
<img class="hideimg" id="quarter" src="">
<img class="hideimg" id="quarterP" src="">
<img class="hideimg" id="sharp" src="">
<img class="hideimg" id="treble" src="">
<img class="hideimg" id="ledger_line" src="">
<h1>Chord:</h1>
<p id="chord-name">Chord Name</p>
<script>
  var conn = null;
  var canv = document.getElementById("main");
  var ctx = canv.getContext("2d");
  var staff = document.getElementById("staff");
  var qNote = document.getElementById("quarter");
  var qNoteP = document.getElementById("quarterP");
  var sharp = document.getElementById("sharp");
  var ledger = document.getElementById("ledger_line");
  var treble = document.getElementById("treble");
  var chordName = document.getElementById("chord-name");
  var keyName = document.getElementById("key-name");
  var sectionTitle = document.getElementById("section-name");
  var elems = [staff, sharp, qNote, qNoteP, treble, ledger]; // Same order as served (laziness)
  var targ = null;

  window.onload = function() {
    var conn = io();
    conn.on("section-name", function(msg) {
      sectionTitle.innerHTML = msg;
    });
    conn.on("key-chng", function(msg) {
      keyName.innerHTML = msg;
    });
    conn.on("serve-image-chunk", function(inf) {
      trg = elems.shift();
      if (inf.image) {
        trg = document.getElementById(inf.title.split('.')[0]);
        trg.setAttribute('src', 'data:image/jpeg;base64,' + inf.buffer);
      }
    });
    conn.on("chord-req", function(msg) {
      if (msg == 0) {
        ctx.clearRect(0, 0, canv.width, canv.height);
        drawStaff();
      } else if (msg != null) {
        ctx.clearRect(0, 0, canv.width, canv.height);
        drawStaff();
        drawNote(msg);
      }
    });
    conn.on("chord-chng", function(msg) {
      chordName.innerHTML = msg;
    });
  }

  function drawStaff() {
    ctx.drawImage(staff, 10, 10, 400, 200);
    ctx.drawImage(treble, 38, 22, 105, 200);
  }

  function drawNote(nt, time=1/4) {
    var note = null;
    var pos = getPos(nt);
    if (time == 1/4) {
      if (pos[1] < -5) {
        note = qNoteP;
        shift = Math.ceil(125/2) + 2;
      } else {
        note = qNote;
        shift = 0;
      }
    }
    ctx.drawImage(note, pos[0], pos[1] + shift, 45, 110);
    if (pos[2]) { // Draw sharp optionally
      ctx.drawImage(sharp, pos[0] - 10, pos[1] + 65, 15, 40);
    }
    if (pos[1] > 90 || (pos[1] < 20 && shift > 0)) { // Draw ledger line
      yOffset = 73;
      if (pos[1] % 25 == 0) {
        yOffset += 12;
      }
      while (pos[1] + yOffset + shift > 175) {
        ctx.drawImage(ledger, pos[0] + 4, pos[1] + yOffset + shift, 35, 2);
        pos[1] -= 25;
      }
      yOffset -= 66;
      while (pos[1] + yOffset + shift < 40 && shift > 0) {
        ctx.drawImage(ledger, pos[0] + 4, pos[1] + yOffset + shift, 35, 2);
        pos[1] += 25;
      }
    }
    return;
  }

  function getPos(val) { // C4 is middle C @ coords 100, 100
    // 25 between spaces. 12 up to line
    var sp = val.split('');
    var oct = parseInt(sp.pop()) - 4;
    var nt = sp.join();
    console.log(sp[0]);
    var noteNum = getNoteNum(sp[0]);
    console.log("noteNum:" + noteNum);
    var octave_dist = 25*3.5;
    var y = 100;
    return [160, y - noteNum*25/2 - oct*octave_dist, (val.length === 3)];
  }

  function getNoteNum(val) {
    var notes = ["C", "D", "E", "F", "G", "A", "B"];
    return notes.indexOf(val);
  }
</script>
</body>
</html>

</html>
